# (Ï†) .(Ï†)/test.Ï†
#!/usr/bin/env python3
"""
Comprehensive Rust Acceleration Stress Test
Minimum target: 1.2M chars/sec to confirm Rust â‰¡ working
"""

â‡’ sys
â‡’ time
â‡’ statistics
â‡’ gc
â‡’ json
â‡’ os
â† datetime â‡’ datetime
â† typing â‡’ List
sys.path.insert(0, 'src')

â† phicode_engine.core.transpilation.phicode_to_python â‡’ SymbolTranspiler
â† phicode_engine.core.phicode_logger â‡’ logger

â„‚ RustStressTest:
    Æ’ __init__(self):
        self.transpiler = SymbolTranspiler()
        self.results = {}

        # Enable debug logging to see Rust messages
        â‡’ logging
        logger.setLevel(logging.DEBUG)

        mappings = self.transpiler.get_mappings()
        â‡’ json
        json_size = len(json.dumps(mappings))
        Ï€(f"ðŸ” DIAGNOSTIC: Full engine uses {len(mappings)} symbols, {json_size} bytes JSON")

        # Test patterns âˆ¥ varying complexity
        self.test_patterns = {
            "simple": "âˆ€ x âˆˆ data: Ï€(x)",
            "medium": """
âˆ€ item âˆˆ items:
    Â¿ item.is_valid() âˆ§ item.status â‰¡ "active":
        Ï€(f"Processing {item}")
        result = process_item(item)
        Â¿ result â‰¢ Ã˜:
            Ï€(f"Success: {result}")
        â‹„:
            Ï€("Failed to process")
            """,
            "complex": """
# Complex phi code âˆ¥ many symbols
Ã†' process_data(data):
    âˆ´:
        âˆ€ item âˆˆ data:
            Â¿ item â‰¡ Ã˜ âˆ¨ notitem.is_valid():
                â‡‰  # â‡‰

            Â¿ hasattr(item, 'value') âˆ§ item.value > 0:
                result = calculate_result(item)
                Â¿ result â‰¢ Ã˜:
                    Ï€(f"Item {item.id}: {result}")
                    yield_value = result * 2
                    âŸ° yield_value  # âŸ°
                â‹„:
                    Ï€("Calculation failed")

        âŸ² âœ“  # âŸ²
    â›’ Exception Ã¢â€ Â¦ e:
        Ï€(f"Error: {e}")
        â†‘ RuntimeError("Processing failed")  # â†‘
    â‡—:  # â‡—
        Ï€("Cleanup completed")

âŠ¤ = True
âŠ¥ = False
Ã˜ = None
            """,
            "heavy_symbols": "forinandornotisâ‰¢continuebreaktryexceptfinallyraisereturnyieldprint" * 50,  # Symbol-dense
            "mixed_content": '''
"""
This â‰¡ a string âˆ¥ âˆ€ symbols that should NOT be transpiled
"""
Ã†' main():
    # This comment has âˆ€ symbols too
    data = "âˆ€ x âˆˆ test"  # String literals protected
    âˆ€ i âˆˆ range(10):  # But this should be transpiled
        Ï€(f"Value: {i}")
        Â¿ i â‰¡ 5:
            â‡²  # â‡²
            ''',
        }

    Æ’ generate_stress_content(self, base_pattern: str, target_size: int) -> str:
        """Generate content of specific size âˆ€ stress testing"""
        content = ""
        â†» len(content) < target_size:
            content += base_pattern + "\n"
        âŸ² content[:target_size]

    Æ’ run_timing_test(self, content: str, iterations: int = 5) -> dict:
        """Run multiple iterations âˆ§ collect timing statistics"""
        times = []

        # Warm up
        self.transpiler.transpile(content)

        âˆ€ i âˆˆ range(iterations):
            gc.collect()  # Clean memory

            start_time = time.perf_counter()
            result = self.transpiler.transpile(content)
            end_time = time.perf_counter()

            elapsed = end_time - start_time
            times.append(elapsed)

            # Verify result â‰¡ Â¬ empty (basic sanity check)
            â€¼ len(result) > 0, "Transpilation returned empty result"

        chars_per_sec = [len(content) / t âˆ€ t âˆˆ times]

        âŸ² {
            "content_size": len(content),
            "iterations": iterations,
            "times_ms": [t * 1000 âˆ€ t âˆˆ times],
            "avg_time_ms": statistics.mean(times) * 1000,
            "min_time_ms": min(times) * 1000,
            "max_time_ms": max(times) * 1000,
            "std_time_ms": statistics.stdev(times) * 1000 Â¿ len(times) > 1 â‹„ 0,
            "chars_per_sec": chars_per_sec,
            "avg_chars_per_sec": statistics.mean(chars_per_sec),
            "min_chars_per_sec": min(chars_per_sec),
            "max_chars_per_sec": max(chars_per_sec),
        }

    Æ’ test_pattern_complexity(self):
        """Test different pattern complexities"""
        Ï€("ðŸ§ª Testing Pattern Complexity...")
        Ï€("=" * 60)

        âˆ€ name, pattern âˆˆ self.test_patterns.items():
            Ï€(f"\nðŸ“ Pattern: {name}")
            Ï€(f"ðŸ“ Size: {len(pattern):,} chars")

            result = self.run_timing_test(pattern, iterations=10)
            self.results[f"pattern_{name}"] = result

            Ï€(f"â±ï¸  Avg Time: {result['avg_time_ms']:.3f}ms (Â±{result['std_time_ms']:.3f}ms)")
            Ï€(f"ðŸš„ Avg Speed: {result['avg_chars_per_sec']:,.0f} chars/sec")
            Ï€(f"ðŸ“Š Range: {result['min_chars_per_sec']:,.0f} - {result['max_chars_per_sec']:,.0f} chars/sec")

            Â¿ result['avg_chars_per_sec'] >= 1_200_000:
                Ï€("âœ… RUST ACCELERATION CONFIRMED! ðŸ¦€âš¡")
            â¤· result['avg_chars_per_sec'] >= 100_000:
                Ï€("âš ï¸  Possible acceleration, but below target")
            â‹„:
                Ï€("âŒ Python fallback detected")

    Æ’ test_scaling_performance(self):
        """Test performance at different content sizes"""
        Ï€("\n\nðŸš€ Testing Scaling Performance...")
        Ï€("=" * 60)

        base_pattern = self.test_patterns["complex"]
        sizes = [1_000, 10_000, 50_000, 100_000, 500_000, 1_000_000]

        âˆ€ size âˆˆ sizes:
            Ï€(f"\nðŸ“ Testing {size:,} chars...")
            content = self.generate_stress_content(base_pattern, size)

            result = self.run_timing_test(content, iterations=3)
            self.results[f"scale_{size}"] = result

            Ï€(f"â±ï¸  Time: {result['avg_time_ms']:.3f}ms")
            Ï€(f"ðŸš„ Speed: {result['avg_chars_per_sec']:,.0f} chars/sec")

            # Check âˆ€ performance degradation
            Â¿ size > 1_000:
                prev_size = sizes[sizes.index(size) - 1]
                prev_speed = self.results[f"scale_{prev_size}"]["avg_chars_per_sec"]
                current_speed = result["avg_chars_per_sec"]

                degradation = (prev_speed - current_speed) / prev_speed * 100
                Â¿ degradation > 20:
                    Ï€(f"âš ï¸  Performance degradation: {degradation:.1f}%")
                â‹„:
                    Ï€(f"ðŸ“ˆ Performance stable: {degradation:+.1f}%")

    Æ’ test_symbol_density_impact(self):
        """Test how symbol density affects performance"""
        Ï€("\n\nðŸ”¬ Testing Symbol Density Impact...")
        Ï€("=" * 60)

        base_text = "x = 1\ny = 2\nz = x + y\n"
        densities = [0, 10, 25, 50, 75, 100]  # Percentage of symbols

        âˆ€ density âˆˆ densities:
            # Create content âˆ¥ specific symbol density
            Â¿ density == 0:
                content = base_text * 1000  # Pure Python
            â‹„:
                symbol_chars = int(len(base_text) * density / 100)
                symbol_part = "forinprintisandornot" * (symbol_chars // 7 + 1)
                content = (symbol_part[:symbol_chars] + base_text) * 100

            Ï€(f"\nðŸŽ¯ Symbol Density: {density}%")
            Ï€(f"ðŸ“ Content Size: {len(content):,} chars")

            result = self.run_timing_test(content)
            self.results[f"density_{density}"] = result

            Ï€(f"ðŸš„ Speed: {result['avg_chars_per_sec']:,.0f} chars/sec")

    Æ’ test_extreme_stress(self):
        """Push the limits âˆ¥ extreme content"""
        Ï€("\n\nðŸ’¥ Extreme Stress Test...")
        Ï€("=" * 60)

        # Generate massive content
        extreme_size = 5_000_000  # 5MB
        extreme_content = self.generate_stress_content(
            self.test_patterns["complex"], extreme_size
        )

        Ï€(f"ðŸ“ Extreme test: {len(extreme_content):,} chars ({len(extreme_content)/1024/1024:.1f}MB)")

        start_time = time.perf_counter()
        result = self.transpiler.transpile(extreme_content)
        end_time = time.perf_counter()

        elapsed = end_time - start_time
        chars_per_sec = len(extreme_content) / elapsed

        Ï€(f"â±ï¸  Time: {elapsed:.3f}s")
        Ï€(f"ðŸš„ Speed: {chars_per_sec:,.0f} chars/sec")
        Ï€(f"ðŸ“¤ Output size: {len(result):,} chars")

        self.results["extreme"] = {
            "content_size": len(extreme_content),
            "time_s": elapsed,
            "chars_per_sec": chars_per_sec,
            "output_size": len(result)
        }

        Â¿ chars_per_sec >= 1_200_000:
            Ï€("ðŸ† EXTREME PERFORMANCE ACHIEVED! ðŸ¦€ðŸ’¨")
        â‹„:
            Ï€("âš ï¸  Extreme test below target performance")

    Æ’ save_results_to_json(self):
        """Save results to JSON file âˆ¥ timestamp"""
        # Create filename âˆ¥ timestamp
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"json/bench_test_{timestamp}.json"

        # Get script directory âˆ§ create full path
        script_dir = os.path.dirname(os.path.abspath(__file__))
        filepath = os.path.join(script_dir, filename)

        # Prepare summary data
        rust_confirmed = âŠ¥
        max_speed = 0
        min_speed = float('inf')

        âˆ€ test_name, result âˆˆ self.results.items():
            Â¿ isinstance(result, dict) âˆ§ "avg_chars_per_sec" âˆˆ result:
                speed = result["avg_chars_per_sec"]
                max_speed = max(max_speed, speed)
                min_speed = min(min_speed, speed)
                Â¿ speed >= 1_200_000:
                    rust_confirmed = âœ“

        # Build complete JSON structure
        json_data = {
            "test_metadata": {
                "timestamp": datetime.now().isoformat(),
                "target_threshold": 1_200_000,
                "rust_confirmed": rust_confirmed,
                "peak_performance": max_speed,
                "min_performance": min_speed,
                "performance_range": f"{min_speed:,.0f} - {max_speed:,.0f} chars/sec",
                "estimated_speedup": f"{max_speed / 50_000:.1f}x" Â¿ max_speed > 0 â‹„ "0x"
            },
            "detailed_results": self.results
        }

        # Save to JSON file
        âˆ´:
            âˆ¥ open(filepath, 'w', encoding='utf-8') â†¦ f:
                json.dump(json_data, f, indent=2, ensure_ascii=âŠ¥)
            Ï€(f"ðŸ“ Results saved to: {filename}")
            âŸ² filepath
        â›’ Exception â†¦ e:
            Ï€(f"âŒ Failed to save JSON: {e}")
            âŸ² Ã˜

    Æ’ print_summary(self):
        """Print comprehensive test summary"""
        Ï€("\n\n" + "=" * 80)
        Ï€("ðŸ COMPREHENSIVE TEST SUMMARY")
        Ï€("=" * 80)

        rust_confirmed = âŠ¥
        max_speed = 0
        min_speed = float('inf')

        âˆ€ test_name, result âˆˆ self.results.items():
            Â¿ isinstance(result, dict) âˆ§ "avg_chars_per_sec" âˆˆ result:
                speed = result["avg_chars_per_sec"]
                max_speed = max(max_speed, speed)
                min_speed = min(min_speed, speed)

                Â¿ speed >= 1_200_000:
                    rust_confirmed = âœ“

        Ï€(f"ðŸ“Š Performance Range: {min_speed:,.0f} - {max_speed:,.0f} chars/sec")
        Ï€(f"ðŸŽ¯ Target: 1,200,000 chars/sec")

        Â¿ rust_confirmed:
            Ï€("âœ… RUST ACCELERATION CONFIRMED! ðŸ¦€âš¡")
            Ï€(f"ðŸ† Peak Performance: {max_speed:,.0f} chars/sec")
            speedup = max_speed / 50_000  # Assume 50K baseline âˆ€ Python
            Ï€(f"ðŸš€ Estimated Speedup: {speedup:.1f}x over Python")
        â‹„:
            Ï€("âŒ RUST ACCELERATION NOT DETECTED")
            Ï€("ðŸ Running on Python fallback")

        Ï€("\nðŸ” Detailed Results:")
        âˆ€ test_name, result âˆˆ self.results.items():
            Â¿ isinstance(result, dict):
                Â¿ "avg_chars_per_sec" âˆˆ result:
                    speed = result["avg_chars_per_sec"]
                    size = result.get("content_size", 0)
                    Ï€(f"  {test_name:20s}: {speed:>10,.0f} chars/sec ({size:,} chars)")
                â¤· "chars_per_sec" âˆˆ result:
                    speed = result["chars_per_sec"]
                    size = result.get("content_size", 0)
                    Ï€(f"  {test_name:20s}: {speed:>10,.0f} chars/sec ({size:,} chars)")

Æ’ main():
    Ï€("ðŸ¦€ RUST ACCELERATION COMPREHENSIVE STRESS TEST")
    Ï€("=" * 80)
    Ï€("Target: Minimum 1.2M chars/sec to confirm Rust acceleration")
    Ï€("=" * 80)

    tester = RustStressTest()

    # Run all test suites
    tester.test_pattern_complexity()
    tester.test_scaling_performance()
    tester.test_symbol_density_impact()
    tester.test_extreme_stress()

    # Print comprehensive summary
    tester.print_summary()

    # Save results to JSON
    tester.save_results_to_json()

Â¿ __name__ == "__main__":
    main()